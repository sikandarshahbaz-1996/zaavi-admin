module.exports = {

"[project]/.next-internal/server/app/api/twilio-logs/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route.runtime.dev.js [external] (next/dist/compiled/next-server/app-route.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page.runtime.dev.js [external] (next/dist/compiled/next-server/app-page.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/assert [external] (assert, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}}),
"[externals]/tty [external] (tty, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tty", () => require("tty"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[project]/src/app/api/twilio-logs/route.js [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// app/api/twilio-logs/route.js
__turbopack_context__.s({
    "GET": (()=>GET)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$twilio$2f$lib$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/twilio/lib/index.js [app-route] (ecmascript)");
;
;
async function fetchUsdToCadRate() {
    const res = await fetch("https://api.frankfurter.app/latest?from=USD&to=CAD");
    if (!res.ok) return 1.42;
    const data = await res.json();
    return data.rates?.CAD || 1.42;
}
const accountSid = process.env.TWILIO_ACCOUNT_SID;
const authToken = process.env.TWILIO_AUTH_TOKEN;
const client = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$twilio$2f$lib$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])(accountSid, authToken);
const monthlyFeeMapUsd = {
    "+17073832531": 0
};
function cleanNumber(num) {
    return num.replace(/^whatsapp:/, "").replace(/\s+/g, "");
}
async function GET(req) {
    const url = new URL(req.url);
    const month = parseInt(url.searchParams.get("month")) || 1;
    const year = parseInt(url.searchParams.get("year")) || 2025;
    const usdToCadRate = await fetchUsdToCadRate();
    const incomingNumbers = await client.incomingPhoneNumbers.list({
        limit: 100
    });
    const phoneNameMap = {};
    incomingNumbers.forEach((pn)=>{
        const cleaned = cleanNumber(pn.phoneNumber);
        phoneNameMap[cleaned] = pn.friendlyName;
    });
    const allCalls = await client.calls.list({
        limit: 1000
    });
    const filteredCalls = allCalls.filter((call)=>{
        const start = new Date(call.startTime);
        return start.getMonth() + 1 === month && start.getFullYear() === year;
    });
    const allMessages = await client.messages.list({
        limit: 1000
    });
    const filteredMessages = allMessages.filter((msg)=>{
        const date = new Date(msg.dateSent);
        return date.getMonth() + 1 === month && date.getFullYear() === year;
    });
    const usageByNumber = {};
    function ensurePhoneEntry(phone) {
        if (!usageByNumber[phone]) {
            usageByNumber[phone] = {
                friendlyName: phoneNameMap[phone] || "",
                inboundMinutes: 0,
                outboundMinutes: 0,
                inboundSms: 0,
                outboundSms: 0,
                totalSpentUSD: 0
            };
        }
        return usageByNumber[phone];
    }
    filteredCalls.forEach((call)=>{
        const durationSeconds = parseInt(call.duration, 10) || 0;
        const durationMinutes = durationSeconds / 60;
        const price = Math.abs(Number(call.price || 0));
        if (call.direction.includes("inbound")) {
            const toNum = cleanNumber(call.to);
            if (!phoneNameMap[toNum]) return;
            const entry = ensurePhoneEntry(toNum);
            entry.inboundMinutes += durationMinutes;
            entry.totalSpentUSD += price;
        } else {
            const fromNum = cleanNumber(call.from);
            if (!phoneNameMap[fromNum]) return;
            const entry = ensurePhoneEntry(fromNum);
            entry.outboundMinutes += durationMinutes;
            entry.totalSpentUSD += price;
        }
    });
    filteredMessages.forEach((msg)=>{
        const price = Math.abs(Number(msg.price || 0));
        if (msg.direction.includes("inbound")) {
            const toNum = cleanNumber(msg.to);
            if (!phoneNameMap[toNum]) return;
            const entry = ensurePhoneEntry(toNum);
            entry.inboundSms += 1;
            entry.totalSpentUSD += price;
        } else {
            const fromNum = cleanNumber(msg.from);
            if (!phoneNameMap[fromNum]) return;
            const entry = ensurePhoneEntry(fromNum);
            entry.outboundSms += 1;
            entry.totalSpentUSD += price;
        }
    });
    const result = Object.keys(usageByNumber).map((phone)=>{
        const data = usageByNumber[phone];
        const usageSpentCad = data.totalSpentUSD * usdToCadRate;
        const monthlyFeeUsd = monthlyFeeMapUsd[phone] !== undefined ? monthlyFeeMapUsd[phone] : 1.50;
        const monthlyFeeCad = monthlyFeeUsd * usdToCadRate;
        const grandTotalCad = usageSpentCad + monthlyFeeCad;
        return {
            number: phone,
            friendlyName: data.friendlyName,
            inboundMinutes: data.inboundMinutes.toFixed(2),
            outboundMinutes: data.outboundMinutes.toFixed(2),
            inboundSms: data.inboundSms,
            outboundSms: data.outboundSms,
            usageCost: usageSpentCad.toFixed(4),
            monthlyFee: monthlyFeeCad.toFixed(4),
            totalSpent: grandTotalCad.toFixed(4)
        };
    });
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(result);
}
}}),

};

//# sourceMappingURL=%5Broot%20of%20the%20server%5D__fc9526b2._.js.map